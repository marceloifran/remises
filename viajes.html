<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Viajes</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
    crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.0/dist/sweetalert2.min.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Reina Remis</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="mapa.html">Mapa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="zonas.html">Destinos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="inicio.html">Inicio</a>
                </li>
            </ul>

            <!-- Botón de Logout -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <button class="btn btn-outline-danger" onclick="cerrarSesion()">Logout</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4 text-center">Administrar Viajes</h1>

            <!-- Botón para abrir el modal de agregar viaje -->
            <div class="d-flex justify-content-center mb-4 fixed-bottom">
                <a data-bs-toggle="modal" data-bs-target="#modalAgregarViaje" class="btn btn-floating btn-lg btn-warning" style="padding: 10px 16px; margin-right: 10px;"><i class="fas fa-plus"></i></a>
            </div>

            <!-- Lista de Viajes como cards -->
            <div class="card-group" id="listaViajes"></div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar viaje -->
<div class="modal fade" id="modalViaje" tabindex="-1" aria-labelledby="modalViajeLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalViajeLabel">Agregar/Editar Viaje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar/editar un viaje -->
                <form id="viajeForm">
                    <div class="mb-3">
                        <label for="usuarioModal">Usuario:</label>
                        <select class="form-select" id="usuarioModal" required>
                            <!-- Opciones de usuario, cargar dinámicamente desde Firebase Authentication -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="zonaModal">Zona:</label>
                        <input type="text" class="form-control" id="zonaModal" required>
                    </div>
                    <div class="mb-3">
                        <label for="metodoPagoModal">Método de Pago:</label>
                        <select class="form-select" id="metodoPagoModal" required>
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta de Crédito</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <!-- Agrega más opciones según tus necesidades -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fechaModal">Fecha:</label>
                        <input type="date" class="form-control" id="fechaModal" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="horaModal">Hora:</label>
                        <input type="time" class="form-control" id="horaModal" value="" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="guardarViaje()">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Agrega el script de Bootstrap y Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-firestore.js"></script>
<!-- Agrega las bibliotecas de Bootstrap y jQuery -->
<!-- si no reconoce $ falta los 3 de abajo -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.0/dist/sweetalert2.all.min.js"></script>

<script>
    var firebaseConfig = {
    apiKey: "AIzaSyDMQMX2wrZ7X_ISg2K7z3xJKEl5Hsa_9sQ",
    authDomain: "remises-e97bb.firebaseapp.com",
    projectId: "remises-e97bb",
    storageBucket: "remises-e97bb.appspot.com",
    messagingSenderId: "497187806637",
    appId: "1:497187806637:web:e6fe9c603f4e0a82e39524",
    measurementId: "G-CHH2E5Y297"
  };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Referencia al servicio de autenticación de Firebase
    var auth = firebase.auth();

    // Referencia a la colección "viajes" en Firebase (Firestore)
    var viajesRef = firebase.firestore().collection('viajes');

    // Variable para almacenar la clave del viaje actualmente seleccionado para edición
    var viajeActualKey;

    // Obtener la lista de usuarios y cargar el select
    auth.onAuthStateChanged(function(user) {
        if (user) {
            var selectUsuarios = document.getElementById("usuarioModal");
            var option = document.createElement("option");
            option.value = user.uid;
            option.text = user.email;
            selectUsuarios.add(option);
        }
    });

    // Cargar la lista de viajes al cargar la página
    cargarListaViajes();

    // Función para cargar la lista de viajes como cards
    function cargarListaViajes() {
        viajesRef.onSnapshot(function(snapshot) {
            var listaViajes = document.getElementById('listaViajes');
            listaViajes.innerHTML = ''; // Limpiar la lista antes de agregar los nuevos elementos

            // Definir la variable 'viajes' antes de asignarle valores
            viajes = {};

            snapshot.forEach(function(doc) {
                var viaje = doc.data();

                // Crear una card para cada viaje
                var card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<div class="card-body">' +
                                    '<h5 class="card-title">' + viaje.zona + '</h5>' +
                                    '<p class="card-text">Usuario: ' + viaje.usuario + '<br>' +
                                    'Método de Pago: ' + viaje.metodoPago + '<br>' +
                                    'Fecha: ' + viaje.fecha + '<br>' +
                                    'Hora: ' + viaje.hora + '</p>' +
                                    '<button class="btn btn-warning" onclick="editarViaje(\'' + doc.id + '\')">Editar</button>' +
                                    '<button class="btn btn-danger" onclick="eliminarViaje(\'' + doc.id + '\')">Eliminar</button>' +
                                  '</div>';

                listaViajes.appendChild(card);

                // Almacenar el viaje en la variable 'viajes' con la clave como índice
                viajes[doc.id] = viaje;
            });
        });
    }

    // Función para cargar los datos del viaje en el modal de editar
    function editarViaje(viajeKey) {
        var viaje = viajes[viajeKey];
        document.getElementById("usuarioModal").value = viaje.usuario;
        document.getElementById("zonaModal").value = viaje.zona;
        document.getElementById("metodoPagoModal").value = viaje.metodoPago;
        document.getElementById("fechaModal").value = viaje.fecha;
        document.getElementById("horaModal").value = viaje.hora;

        // Guardar la clave del viaje actual para la actualización posterior
        viajeActualKey = viajeKey;

        // Abrir el modal
        var modal = new bootstrap.Modal(document.getElementById('modalViaje'));
        modal.show();
    }

    // Función para eliminar un viaje
    function eliminarViaje(viajeKey) {
        if (confirm('¿Estás seguro de que quieres eliminar este viaje?')) {
            viajesRef.doc(viajeKey).delete().then(function() {
                cargarListaViajes(); // Actualizar la lista después de eliminar un viaje
            }).catch(function(error) {
                console.error("Error al eliminar el viaje: ", error);
            });
        }
    }
</script>

</body>
</html>
